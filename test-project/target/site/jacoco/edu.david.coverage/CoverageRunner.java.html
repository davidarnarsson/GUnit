<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CoverageRunner.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">test-project</a> &gt; <a href="index.source.html" class="el_package">edu.david.coverage</a> &gt; <span class="el_source">CoverageRunner.java</span></div><h1>CoverageRunner.java</h1><pre class="source lang-java linenums">package edu.david.coverage;

import junit.framework.Test;
import org.junit.runner.Computer;
import org.junit.runner.JUnitCore;
import org.junit.runner.Result;
import org.junit.runners.AllTests;
import edu.david.linkedlist.LinkedList;
import etse.core.classloader.ClazzLoader;
import org.jacoco.core.analysis.Analyzer;
import org.jacoco.core.analysis.CoverageBuilder;
import org.jacoco.core.analysis.IClassCoverage;
import org.jacoco.core.analysis.ICounter;
import org.jacoco.core.data.ExecutionDataStore;
import org.jacoco.core.data.SessionInfoStore;
import org.jacoco.core.instr.Instrumenter;
import org.jacoco.core.runtime.IRuntime;
import org.jacoco.core.runtime.LoggerRuntime;
import org.jacoco.core.runtime.RuntimeData;

import java.io.InputStream;
import java.io.PrintStream;
import java.util.HashMap;
import java.util.Map;

/**
 * Based on
 * http://www.eclemma.org/jacoco/trunk/doc/examples/java/CoreTutorial.java
 *
 * Created by davida on 3.2.2015.
 */
public class CoverageRunner {
    /**
     * A class loader that loads classes from in-memory data.
     */

    private PrintStream out;

<span class="nc" id="L39">    public CoverageRunner(PrintStream o) {</span>
<span class="nc" id="L40">        out = o;</span>
<span class="nc" id="L41">    }</span>

<span class="nc" id="L43">    public static class MemoryClassLoader extends ClassLoader {</span>

<span class="nc" id="L45">        private final Map&lt;String, byte[]&gt; definitions = new HashMap&lt;String, byte[]&gt;();</span>

        /**
         * Add a in-memory representation of a class.
         *
         * @param name
         *            name of the class
         * @param bytes
         *            class definition
         */
        public void addDefinition(final String name, final byte[] bytes) {
<span class="nc" id="L56">            definitions.put(name, bytes);</span>
<span class="nc" id="L57">        }</span>

        @Override
        protected Class&lt;?&gt; loadClass(final String name, final boolean resolve)
                throws ClassNotFoundException {
<span class="nc" id="L62">            final byte[] bytes = definitions.get(name);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (bytes != null) {</span>
<span class="nc" id="L64">                return defineClass(name, bytes, 0, bytes.length);</span>
            }
<span class="nc" id="L66">            return super.loadClass(name, resolve);</span>
        }

    }
    public IClassCoverage execute(String clazz) throws Throwable {

<span class="nc" id="L72">        final IRuntime runtime = new LoggerRuntime();</span>

<span class="nc" id="L74">        final Instrumenter instrumenter = new Instrumenter(runtime);</span>

<span class="nc" id="L76">        byte[] instrumented = instrumenter.instrument(getTargetClass(clazz),clazz);</span>

<span class="nc" id="L78">        final RuntimeData data = new RuntimeData();</span>

<span class="nc" id="L80">        runtime.startup(data);</span>

<span class="nc" id="L82">        final MemoryClassLoader memoryClassLoader = new MemoryClassLoader();</span>
<span class="nc" id="L83">        memoryClassLoader.addDefinition(clazz, instrumented);</span>
<span class="nc" id="L84">        final Class&lt;?&gt; targetClass = memoryClassLoader.loadClass(clazz);</span>

<span class="nc" id="L86">        Computer computer = new Computer();</span>

<span class="nc" id="L88">        JUnitCore core = new JUnitCore();</span>
<span class="nc" id="L89">        Result r = core.run(computer, Class.forName(&quot;edu.david.linkedlisttests.LinkedListTests&quot;));</span>


<span class="nc" id="L92">        final ExecutionDataStore executionData = new ExecutionDataStore();</span>
<span class="nc" id="L93">        final SessionInfoStore sessionInfos = new SessionInfoStore();</span>
<span class="nc" id="L94">        data.collect(executionData, sessionInfos, false);</span>
<span class="nc" id="L95">        runtime.shutdown();</span>

<span class="nc" id="L97">        final CoverageBuilder coverageBuilder = new CoverageBuilder();</span>
<span class="nc" id="L98">        final Analyzer analyzer = new Analyzer(executionData, coverageBuilder);</span>
<span class="nc" id="L99">        analyzer.analyzeClass(getTargetClass(clazz), clazz);</span>


        // Let's dump some metrics and line coverage information:
<span class="nc bnc" id="L103" title="All 2 branches missed.">        for (final IClassCoverage cc : coverageBuilder.getClasses()) {</span>
<span class="nc" id="L104">            out.printf(&quot;Coverage of class %s%n&quot;, cc.getName());</span>

<span class="nc" id="L106">            printCounter(&quot;instructions&quot;, cc.getInstructionCounter());</span>
<span class="nc" id="L107">            printCounter(&quot;branches&quot;, cc.getBranchCounter());</span>
<span class="nc" id="L108">            printCounter(&quot;lines&quot;, cc.getLineCounter());</span>
<span class="nc" id="L109">            printCounter(&quot;methods&quot;, cc.getMethodCounter());</span>
<span class="nc" id="L110">            printCounter(&quot;complexity&quot;, cc.getComplexityCounter());</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">            for (int i = cc.getFirstLine(); i &lt;= cc.getLastLine(); i++) {</span>
<span class="nc" id="L113">                out.printf(&quot;Line %s: %s%n&quot;, Integer.valueOf(i), getColor(cc</span>
<span class="nc" id="L114">                        .getLine(i).getStatus()));</span>
            }
<span class="nc" id="L116">        }</span>

<span class="nc" id="L118">        return (IClassCoverage)coverageBuilder.getClasses();</span>
    }

    private void printCounter(final String unit, final ICounter counter) {
<span class="nc" id="L122">        final Integer missed = Integer.valueOf(counter.getMissedCount());</span>
<span class="nc" id="L123">        final Integer total = Integer.valueOf(counter.getTotalCount());</span>
<span class="nc" id="L124">        out.printf(&quot;%s of %s %s missed%n&quot;, missed, total, unit);</span>
<span class="nc" id="L125">    }</span>

    private String getColor(final int status) {
<span class="nc bnc" id="L128" title="All 4 branches missed.">        switch (status) {</span>
            case ICounter.NOT_COVERED:
<span class="nc" id="L130">                return &quot;red&quot;;</span>
            case ICounter.PARTLY_COVERED:
<span class="nc" id="L132">                return &quot;yellow&quot;;</span>
            case ICounter.FULLY_COVERED:
<span class="nc" id="L134">                return &quot;green&quot;;</span>
        }
<span class="nc" id="L136">        return &quot;&quot;;</span>
    }

    private InputStream getTargetClass(String name) {
<span class="nc" id="L140">        String file = '/' + name.replace('.', '/') + &quot;.class&quot;;</span>

<span class="nc" id="L142">        return getClass().getResourceAsStream(file);</span>
    }



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>